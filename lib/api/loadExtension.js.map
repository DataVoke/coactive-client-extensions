{"version":3,"sources":["../../src/api/loadExtension.js"],"names":["_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_createClass","protoProps","staticProps","prototype","_setPrototypeOf","o","p","setPrototypeOf","__proto__","_inherits","subClass","superClass","create","constructor","value","_extends","assign","arguments","source","hasOwnProperty","call","apply","api","transformJavaScript","code","forceTransform","_supportLegacyBrowser","Babel","toString","transform","presets","parserOpts","allowReturnOutsideFunction","evalTransformedJavaScript","transformed","eval","overrideExtensionsRegisterAction","_originalRegisterAction","app","dv","cache","extensions","registerAction","action","Definition","CreateSettingsPanel","Execute","GetFriendlyName","Settings","overrideRunJavaScriptActionExecute","_originalRunJavaScriptActionExecute","actionLibrary","actionStores","dvCore","RunJavaScript","options","callback","JsText","loadExtension","namespace","loader","utils","supportsES6","loadResource","loadExtensionCache","allActions","Values","executionHelper","resolve"],"mappings":"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","sourcesContent":["export default (() => {\n    /**\n     * api.loadExtension\n     * Create an extension loader that can be used to extend the app's client-side API.\n     */\n    // These are dependencies of babel-standalone\n    function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } };\n    function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } };\n    function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; };\n    function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); };\n    function _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function\"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); };\n    function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\n    if (!api.transformJavaScript) {\n        api.transformJavaScript = function (code, forceTransform) {\n            if (code) {\n                // Use Babel to transform JavaScript for older browsers, if available\n                if ((api._supportLegacyBrowser || forceTransform) && Babel) {\n                    // Coerce the code to a string in case it's a function and then transform it\n                    if (typeof code !== \"string\") {\n                        code = code.toString();\n                    }\n                    return Babel.transform(code, { presets: [\"react\", \"es2015\", \"stage-0\"], parserOpts: { allowReturnOutsideFunction: true } }).code;\n                } else {\n                    return code;\n                }\n            } else {\n                return null;\n            }\n        };\n    }\n\n    if (!api.evalTransformedJavaScript) {\n        api.evalTransformedJavaScript = function (code, forceTransform) {\n            var transformed = api.transformJavaScript(code, forceTransform);\n            if (transformed) {\n                if (typeof transformed === \"string\") {\n                    return eval(transformed);\n                } else if (typeof transformed === \"function\") {\n                    // If we still have a function, just execute it\n                    return transformed();\n                }\n            }\n        };\n    }\n\n    var overrideExtensionsRegisterAction = function () {\n        // Override the original extensions.registerAction function to transform code for older browsers\n        if (!api._originalRegisterAction) {\n            api._originalRegisterAction = app.dv.cache.extensions.registerAction;\n            app.dv.cache.extensions.registerAction = function (action) {\n                // Call the original function to register the actions\n                api._originalRegisterAction(action);\n                // Replace each code block with its transformed version and evaluate it so the transformed code executes when called\n                if (action.Definition.CreateSettingsPanel) {\n                    action.Definition.CreateSettingsPanel = api.evalTransformedJavaScript(\"(\" + action.Definition.CreateSettingsPanel + \")\");\n                }\n                if (action.Definition.Execute) {\n                    action.Definition.Execute = api.evalTransformedJavaScript(\"(\" + action.Definition.Execute + \")\");\n                }\n                if (action.Definition.GetFriendlyName) {\n                    action.Definition.GetFriendlyName = api.evalTransformedJavaScript(\"(\" + action.Definition.GetFriendlyName + \")\");\n                }\n                if (action.Definition.Settings) {\n                    action.Definition.Settings = api.evalTransformedJavaScript(\"(\" + action.Definition.Settings + \")\");\n                }\n            };\n        }\n    };\n\n    var overrideRunJavaScriptActionExecute = function () {\n        // Override the original action Execute function to transform code for older browsers\n        if (!api._originalRunJavaScriptActionExecute) {\n            api._originalRunJavaScriptActionExecute = app.dv.actionLibrary.actionStores.dvCore.RunJavaScript.Definition.Execute;\n            app.dv.actionLibrary.actionStores.dvCore.RunJavaScript.Definition.Execute = function (options, callback) {\n                // Transform the JavaScript and call original Execute function\n                options.action.Settings.JsText = api.transformJavaScript(options.action.Settings.JsText);\n                api._originalRunJavaScriptActionExecute(options, callback);\n            };\n        }\n    };\n\n    if (!api.loadExtension) {\n        // Create an extension loader that can be used to extend the app's client-side API\n        api.loadExtension = function (namespace, loader) {\n            // Create the namespace if it doesn't exist\n            if (typeof namespace === \"string\" && !eval(namespace)) {\n                eval(namespace + \" = {}\");\n            }\n\n            // If we have a loader, execute it\n            if (loader) {\n                if (api.evalTransformedJavaScript) {\n                    // Transform JavaScript for older browsers if required and available\n                    api.evalTransformedJavaScript(\"(\" + loader + \")();\");\n                } else {\n                    loader();\n                }\n            }\n        };\n    }\n\n    // Determine if we need to support a legacy browser\n    // (may be forced by setting api._supportLegacyBrowser to true; otherwise detected here)\n    if (api._supportLegacyBrowser !== true && api.utils.supportsES6()) {\n        api._supportLegacyBrowser = false;\n    } else {\n        api._supportLegacyBrowser = true;\n        // Load Babel to transform JavaScript for older browsers\n        api.utils.loadResource(\"babel-standalone@6.26.0\", \"npm\", function() {\n            // Re-register all custom actions so they use transformed JavaScript\n            app.dv.cache.loadExtensionCache(app.dv.cache.extensions.allActions.Values);\n            executionHelper.resolve();\n        });\n        // We need to transform ES6 JavaScript to ES5\n        overrideExtensionsRegisterAction();\n        overrideRunJavaScriptActionExecute();\n    }\n})();\n"],"file":"loadExtension.js"}