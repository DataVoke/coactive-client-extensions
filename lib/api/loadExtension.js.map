{"version":3,"sources":["../../src/api/loadExtension.js"],"names":["_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_createClass","protoProps","staticProps","prototype","_setPrototypeOf","o","p","setPrototypeOf","__proto__","_inherits","subClass","superClass","create","constructor","value","_extends","assign","arguments","source","hasOwnProperty","call","apply","context","api","transformJavaScript","code","forceTransform","_supportLegacyBrowser","Babel","toString","transform","presets","parserOpts","allowReturnOutsideFunction","evalTransformedJavaScript","transformed","eval","overrideExtensionsRegisterAction","_originalRegisterAction","app","dv","cache","extensions","registerAction","action","Definition","CreateSettingsPanel","Execute","GetFriendlyName","Settings","overrideRunJavaScriptActionExecute","_originalRunJavaScriptActionExecute","actionLibrary","actionStores","dvCore","RunJavaScript","options","callback","JsText","loadExtension","namespace","loader","utils","supportsES6","loadResource","loadExtensionCache","allActions","Values","executionHelper","resolve"],"mappings":"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","sourcesContent":["// NOTE: All code herein should be ES5-compatible. Other extensions will use this module to transpile back to ES5 when necessary, so they may use ES6+\n\n/**\n * Custom Action: context.api.loadExtension\n * Create an extension loader that can be used to extend the app's client-side API.\n */\n// These are dependencies of babel-standalone\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } };\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } };\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; };\nfunction _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); };\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function\"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); };\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nif (!context.api.transformJavaScript) {\n    context.api.transformJavaScript = function (code, forceTransform) {\n        if (code) {\n            // Use Babel to transform JavaScript for older browsers, if available\n            if ((context.api._supportLegacyBrowser || forceTransform) && Babel) {\n                // Coerce the code to a string in case it's a function and then transform it\n                if (typeof code !== \"string\") {\n                    code = code.toString();\n                }\n                return Babel.transform(code, { presets: [\"react\", \"es2015\", \"stage-0\"], parserOpts: { allowReturnOutsideFunction: true } }).code;\n            } else {\n                return code;\n            }\n        } else {\n            return null;\n        }\n    };\n}\n\nif (!context.api.evalTransformedJavaScript) {\n    context.api.evalTransformedJavaScript = function (code, forceTransform) {\n        var transformed = context.api.transformJavaScript(code, forceTransform);\n        if (transformed) {\n            if (typeof transformed === \"string\") {\n                return eval(transformed);\n            } else if (typeof transformed === \"function\") {\n                // If we still have a function, just execute it\n                return transformed();\n            }\n        }\n    };\n}\n\nvar overrideExtensionsRegisterAction = function () {\n    // Override the original extensions.registerAction function to transform code for older browsers\n    if (!context.api._originalRegisterAction) {\n        context.api._originalRegisterAction = context.app.dv.cache.extensions.registerAction;\n        context.app.dv.cache.extensions.registerAction = function (action) {\n            // Call the original function to register the actions\n            context.api._originalRegisterAction(action);\n            // Replace each code block with its transformed version and evaluate it so the transformed code executes when called\n            if (action.Definition.CreateSettingsPanel) {\n                action.Definition.CreateSettingsPanel = context.api.evalTransformedJavaScript(\"(\" + action.Definition.CreateSettingsPanel + \")\");\n            }\n            if (action.Definition.Execute) {\n                action.Definition.Execute = context.api.evalTransformedJavaScript(\"(\" + action.Definition.Execute + \")\");\n            }\n            if (action.Definition.GetFriendlyName) {\n                action.Definition.GetFriendlyName = context.api.evalTransformedJavaScript(\"(\" + action.Definition.GetFriendlyName + \")\");\n            }\n            if (action.Definition.Settings) {\n                action.Definition.Settings = context.api.evalTransformedJavaScript(\"(\" + action.Definition.Settings + \")\");\n            }\n        };\n    }\n};\n\nvar overrideRunJavaScriptActionExecute = function () {\n    // Override the original action Execute function to transform code for older browsers\n    if (!context.api._originalRunJavaScriptActionExecute) {\n        context.api._originalRunJavaScriptActionExecute = context.app.dv.actionLibrary.actionStores.dvCore.RunJavaScript.Definition.Execute;\n        context.app.dv.actionLibrary.actionStores.dvCore.RunJavaScript.Definition.Execute = function (options, callback) {\n            // Transform the JavaScript and call original Execute function\n            options.action.Settings.JsText = context.api.transformJavaScript(options.action.Settings.JsText);\n            context.api._originalRunJavaScriptActionExecute(options, callback);\n        };\n    }\n};\n\nif (!context.api.loadExtension) {\n    // Create an extension loader that can be used to extend the app's client-side API\n    context.api.loadExtension = function (namespace, loader) {\n        // Create the namespace if it doesn't exist\n        if (typeof namespace === \"string\" && !eval(namespace)) {\n            eval(namespace + \" = {}\");\n        }\n\n        // If we have a loader, execute it\n        if (loader) {\n            if (context.api.evalTransformedJavaScript) {\n                // Transform JavaScript for older browsers if required and available\n                context.api.evalTransformedJavaScript(\"(\" + loader + \")();\");\n            } else {\n                loader();\n            }\n        }\n    };\n}\n\n// Determine if we need to support a legacy browser\n// (may be forced by setting context.api._supportLegacyBrowser to true; otherwise detected here)\nif (context.api._supportLegacyBrowser !== true && context.api.utils.supportsES6()) {\n    context.api._supportLegacyBrowser = false;\n} else {\n    context.api._supportLegacyBrowser = true;\n    // Load Babel to transform JavaScript for older browsers\n    context.api.utils.loadResource(\"babel-standalone@6.26.0\", \"npm\", function() {\n        // Re-register all custom actions so they use transformed JavaScript\n        context.app.dv.cache.loadExtensionCache(context.app.dv.cache.extensions.allActions.Values);\n        executionHelper.resolve();\n    });\n    // We need to transform ES6 JavaScript to ES5\n    overrideExtensionsRegisterAction();\n    overrideRunJavaScriptActionExecute();\n}\n"],"file":"loadExtension.js"}